var _test,_step,repeatStepMessage,repeatMessage,verbose=!1,debug=!1,window=this;function mergeObjects(e,t){for(var s in t)e[s]=t[s]}function globalize(e){var t=require(e);mergeObjects(global,t)}this.test=test=void 0,console.log("Beep boop, task.js loaded"),addEventListener("message",function(e){let t=e.data;void 0!==t.messageContext&&("Init"===t.messageContext&&1===t.state&&(debug=t.debug,init()),"Init"===t.messageContext&&3===t.state&&""!==t.test&&(this.host=e.data.host,initTest(e.data.test)),"NeedImage"===t.messageContext&&""!==t.imageData&&void 0!==this.fetchImageDataCallback&&this.fetchImageDataCallback(t.imageData))},!1);var bootSequence={loadScript:function(e){importScripts("../lib/moment.min.js"),!0===debug?(importScripts("../plugins/base.js"),importScripts("../plugins/framework.js"),importScripts("../data/messages.js"),importScripts("../data/test.js")):(importScripts("../plugins.js"),importScripts("../data.js")),needImage=new NeedImage,m_init=new Init,e()},loadPlugins:function(e){if(console.debug("Load base & framework plugin"),void 0==window.plugins||void 0===window.plugins.Framework||void 0===window.plugins.Base)return void e(null,2e3);let t=new window.plugins.Framework;mergeObjects(window,t),e()},initReady:function(e){m_init.setInitReady()}};function loaded(){postMessage({messageContext:"Init",state:0})}function init(){var e=Object.keys(bootSequence);bootStep>e.length-1||bootSequence[e[bootStep]]((e,t)=>{null===e&&void 0!==t?(console.debug(`Retrying bootstep ${bootStep} in ${e} ms`),setTimeout(init,t)):void 0!==e?(console.debug(`Bootstep ${bootStep} completed, starting next in ${e} ms`),bootStep++,setTimeout(init,e)):(console.debug(`Bootstep ${bootStep} completed, starting next`),bootStep++,init())})}var testIsNA=!1,NotApplicable=function(e){testIsNA=!0,void 0!==_test?_test.notApplicable(e):setTimeout(NotApplicable,1e3,e)},fetchImageData=function(e,t){this.fetchImageDataCallback=t,needImage.setURL(e)};function initTest(e){try{importScripts("../tests/"+e+".js")}catch(e){return void(!0!==testIsNA&&process_end("Error, could not load test "+e))}if(test&&void 0!==test.extends)try{var t=test;importScripts("../tests/"+test.extends+".js"),mergeObjects(t.steps,test.steps),test=t}catch(e){process_end("Could not load test to extend, test file not found")}(_test=new Test(test)).name=e,_test&&void 0!==_test.requiredPlugins&&_test.requiredPlugins.length>0?getPlugins(null,e=>{try{for(var t=JSON.parse(e.body).plugins,s=[],i=0;i<t.length;i++)s.push(t[i].callsign);for(var o=0;o<_test.requiredPlugins.length;o++)-1===s.indexOf(_test.requiredPlugins[o])?NotApplicable(`Build does not support ${_test.requiredPlugins[o]}`):o===_test.requiredPlugins.length-1&&startTest()}catch(e){process_end("Failed to retrieve plugins from Framework while checking requiredPlugins")}}):startTest()}let bootStep=0;var maxSteps,steps,stepList,testId,timer,taskTimer,curIdx=-1,processEndRequested=!1,timedOut=!1;function startTest(){!0!==testIsNA&&(stepList=Object.keys(test.steps),maxSteps=stepList.length,_test.start(),taskTimer=setTimeout(timedout,1e3*_test.timeout),lookForNextStep())}function timedout(){_test.timedout(),checkAndCleanup(()=>{_test.complete(),setTimeout(close,1e3)})}function checkAndCleanup(e){void 0!==_test.cleanup?_test.cleanup(t=>{_test.cleanedup(t),_test.complete(),s(e,1e3)}):e()}function process_end(e){!0===processEndRequested&&close(1),processEndRequested=!0,clearTimeout(timer),void 0!==e&&_test.error(e),void 0!==e?checkAndCleanup(()=>{_test.complete(),setTimeout(close,1e3)}):(_test.complete(),setTimeout(close,1e3))}function lookForNextStep(){clearTimeout(timer);var e=curIdx+1;if(e>=maxSteps)return _test.success(),void process_end();var t=_test.steps[stepList[e]];if(void 0!==t.goto){repeatMessage=new RepeatMessage(e,stepList[e],t.goto);var s=stepList.indexOf(t.goto);t.repeat?(void 0===t.repeatTotal&&((repeatStepMessage=new Step(curIdx+1)).start(),t.repeatTotal=t.repeat),repeatMessage.repeatCount(t.repeat,t.repeatTotal),t.repeat-=1,t.repeat<=0?(repeatMessage.done(),repeatStepMessage.success(),curIdx+=1,lookForNextStep()):startStep(s)):t.repeatTime&&(void 0===t.repeatTimeStamp&&((repeatStepMessage=new Step(curIdx+1)).start(),t.repeatTimeStamp=moment().add(t.repeatTime,"minutes").format(),t.repeatTimes=0),t.repeatTimes++,moment().isAfter(t.repeatTimeStamp)?(repeatMessage.done(),repeatStepMessage.success(),curIdx+=1,lookForNextStep()):(repeatMessage.timedRepeat(t.repeatTimeStamp,t.repeatTimes),startStep(s)))}else void 0!==t.user?askUser(curIdx+1):startStep(curIdx+1)}function startStep(e){curIdx=e,this.currentStep=_test.steps[stepList[curIdx]],this.previousStep=void 0,curIdx>0&&(this.previousStep=test.steps[stepList[curIdx-1]]),void 0!==_step&&delete _step,_step=new Step(this.currentStep,curIdx,stepList[curIdx],_test.name),_test.steps[stepList[curIdx]]=_step,_step.start(),timedOut=!1,timer=setTimeout(timedout,1e3*_step.timeout,curIdx);var t=void 0!==this.currentStep.sleep?1e3*this.currentStep.sleep:1e3,s=void 0!==this.currentStep.test?this.currentStep.test:dummy;function i(e){_step.setResponse(e),validateStep(curIdx,e)}void 0===this.currentStep.params&&(this.currentStep.params=i),setTimeout(function(e){try{s(currentStep.params,i)}catch(e){}},t)}function validateStep(e,t){var s,i=!1,o=test.steps[stepList[e]];o.expect;if(void 0!==o.assert)o.assert==t?i=!0:s=`Step ${e}: expected ${o.assert} while result was ${t}`;else if(void 0!==o.validate&&!o.validate instanceof Function)o.validate==t?i=!0:s=`Step ${e}: expected ${o.assert} while result was ${t}`;else if(void 0!==o.validate&&o.validate instanceof Function){var r=o.validate;try{i=r(t)}catch(t){s=`Error executing validate on step ${e}: ${t}`}}else i=!0;!0===i?(_step.success(s),lookForNextStep()):(_step.fail(s),process_end(s))}function askUser(e){curIdx=e;var t=test.steps[stepList[curIdx]];(_step=new Step(t,curIdx)).start(),_step.needUser(),timer=setTimeout(timedout,1e3*_step.timeout,curIdx)}function userResponse(e){e.state()!==e.states.success?(_step.fail(e.response),process_end(e.response)):(_step.success(e.response),lookForNextStep())}getResponseByStep=function(e){return _test.steps[e].getResponse()},loaded();